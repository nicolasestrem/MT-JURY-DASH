(v=>{v(document).ready(function(){var l=v(".mt-evaluation-table");if(l.length){let r={autoSaveDelay:2e3,minScore:0,maxScore:10,scoreStep:.5},d=new Map,n=new Map;function c(e){return e=Math.round(e/r.scoreStep)*r.scoreStep,Math.max(r.minScore,Math.min(r.maxScore,e))}function e(){l.on("keydown",".mt-eval-score-input",function(e){var t,a=v(this),n=a.parent(),o=n.parent();let s;switch(e.key){case"ArrowUp":e.preventDefault(),(s=o.prev().find("td").eq(n.index()).find(".mt-eval-score-input")).length&&s.focus().select();break;case"ArrowDown":e.preventDefault(),(s=o.next().find("td").eq(n.index()).find(".mt-eval-score-input")).length&&s.focus().select();break;case"ArrowLeft":case"Tab":(e.shiftKey||"ArrowLeft"===e.key)&&(e.preventDefault(),(s=n.prev().find(".mt-eval-score-input")).length)&&s.focus().select();break;case"ArrowRight":e.preventDefault(),(s=n.next().find(".mt-eval-score-input")).length&&s.focus().select();break;case"Enter":e.preventDefault(),o.find(".mt-btn-save-eval").click();break;case"Escape":{var i=o;let t=d.get(i[0]);t&&(Object.keys(t).forEach(e=>{i.find(`input[name="${e}"]`).val(t[e])}),f(i),i.removeClass("unsaved"),i.find(".mt-btn-save-eval").removeClass("unsaved"),d.delete(i[0]))}a.blur()}"+"===e.key||"="===e.key?(e.preventDefault(),t=c(parseFloat(a.val())+r.scoreStep),a.val(t).trigger("input")):"-"!==e.key&&"_"!==e.key||(e.preventDefault(),t=c(parseFloat(a.val())-r.scoreStep),a.val(t).trigger("input"))})}function f(e){let t=0,a=0,n=(e.find(".mt-eval-score-input").each(function(){var e=parseFloat(v(this).val());isNaN(e)||(t+=e,a++)}),0<a?t/a:0);var o=e.find(".mt-eval-total-value"),o=(parseFloat(o.text())!==n&&o.fadeOut(100,function(){v(this).text(n.toFixed(1)).fadeIn(100)}),e.find(".mt-eval-total-score"));o.removeClass("score-high score-low score-medium"),8<=n?o.addClass("score-high"):5<=n?o.addClass("score-medium"):n<=3&&o.addClass("score-low"),e.data("total-score",n)}e(),l.find("th[title]").each(function(){let a=v(this),n=a.attr("title");a.hover(function(){var e=v('<div class="mt-enhanced-tooltip"></div>').text(n).appendTo("body"),t=a.offset();e.css({top:t.top-e.outerHeight()-10,left:t.left+a.outerWidth()/2-e.outerWidth()/2}).fadeIn(200)},function(){v(".mt-enhanced-tooltip").fadeOut(200,function(){v(this).remove()})})}),l.on("focus",".mt-eval-score-input",function(){var e=v(this).closest("tr");if(!d.has(e[0])){let t={};e.find(".mt-eval-score-input").each(function(){var e=v(this);t[e.attr("name")]=e.val()}),d.set(e[0],t)}}),l.on("input",".mt-eval-score-input",function(){let e=v(this).closest("tr"),t=e.data("candidate-id");f(e),e.addClass("unsaved"),e.find(".mt-btn-save-eval").addClass("unsaved"),n.has(t)&&clearTimeout(n.get(t));var a=setTimeout(()=>{e.hasClass("unsaved")&&e.find(".mt-btn-save-eval").click(),n.delete(t)},r.autoSaveDelay);n.set(t,a),clearTimeout(window.rerankTimer),window.rerankTimer=setTimeout(function(){{let a=l.find("tbody"),o=a.find("tr.mt-eval-row").get(),s=(o.sort(function(e,t){e=parseFloat(v(e).data("total-score")||v(e).find(".mt-eval-total-value").text())||0;return(parseFloat(v(t).data("total-score")||v(t).find(".mt-eval-total-value").text())||0)-e}),{}),n=(o.forEach((e,t)=>{var e=v(e),a=e.data("candidate-id"),e=e.find(".mt-ranking-badge");s[a]=parseInt(e.data("position")||t+1)}),v.each(o,function(e,t){var a=v(t);let n=e+1;var t=a.data("candidate-id"),e=s[t],t=a.find(".mt-eval-rank").find(".mt-ranking-badge");e!==n&&(t.attr("data-position",n),(e=t.find(".mt-rank-number")).length&&e.fadeOut(200,function(){v(this).text(n).fadeIn(200)}),(e=t.find("svg text")).length&&e.fadeOut(200,function(){v(this).text(n).fadeIn(200)}),t.removeClass("mt-rank-gold mt-rank-silver mt-rank-bronze mt-rank-standard"),1===n?t.addClass("mt-rank-gold"):2===n?t.addClass("mt-rank-silver"):3===n?t.addClass("mt-rank-bronze"):t.addClass("mt-rank-standard"),(e=t.find(".mt-medal-icon")).length)&&(e.removeClass("mt-medal-gold mt-medal-silver mt-medal-bronze"),1===n?e.addClass("mt-medal-gold"):2===n?e.addClass("mt-medal-silver"):3===n&&e.addClass("mt-medal-bronze")),a.removeClass("position-gold position-silver position-bronze");for(let e=1;e<=o.length;e++)a.removeClass("rank-"+e);1===n?a.addClass("position-gold"):2===n?a.addClass("position-silver"):3===n&&a.addClass("position-bronze"),a.addClass("rank-"+n)}),0<o.length?v(o[0]).outerHeight():50),i={};o.forEach((e,t)=>{e=v(e);i[e.data("candidate-id")]=t*n}),o.forEach(e=>{var e=v(e),t=e.data("candidate-id"),a=e.position().top,t=i[t];5<Math.abs(a-t)&&e.css({position:"relative",top:0,zIndex:100}).animate({top:t-a},400,function(){v(this).css({position:"",top:"",zIndex:""})})}),setTimeout(function(){v.each(o,function(e,t){a.append(t)})},450)}},500)}),l.on("change",".mt-eval-score-input",function(){var e=v(this),t=parseFloat(e.val()),a=parseFloat(e.data("oldValue")||e.val());a!==t&&(((e,t,a)=>{if(a-=t,t=v('<span class="mt-score-change-indicator"></span>'),0<a)t.text("+"+a.toFixed(1)).addClass("positive");else{if(!(a<0))return;t.text(a.toFixed(1)).addClass("negative")}a=e.offset(),t.css({position:"absolute",left:a.left+e.outerWidth()-20,top:a.top-10,zIndex:1e3}).appendTo("body"),t.animate({top:a.top-30,opacity:0},800,function(){v(this).remove()})})(e,a,t),e.data("oldValue",t))})}})})(jQuery);