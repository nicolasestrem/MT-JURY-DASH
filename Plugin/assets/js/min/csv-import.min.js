!function(t){"use strict";const s={isImporting:!1,progressInterval:null,init:function(){this.bindEvents(),this.setupProgressModal()},bindEvents:function(){t("#mt-import-form").on("submit",this.handleFormSubmit.bind(this));const s=t('form[action*="admin-post.php"]').filter(function(){return t(this).find('input[name="action"][value="mt_import_data"]').length>0});s.length&&this.enhanceStandardForm(s),t("#csv_file").on("change",this.validateFile.bind(this)),t("#import_type").on("change",this.updateImportHelp.bind(this))},enhanceStandardForm:function(s){const e=s.find('button[type="submit"]');if(e.length){const r=t("<button/>",{type:"button",class:"button button-secondary mt-ajax-import-btn",html:'<span class="dashicons dashicons-upload"></span> '+mt_csv_import.i18n.ajax_import,style:"margin-left: 10px;"});r.on("click",t=>{t.preventDefault(),this.handleAjaxImport(s)}),e.after(r)}},handleFormSubmit:function(s){if(s.preventDefault(),this.isImporting)return!1;const e=t(s.target);return this.handleAjaxImport(e),!1},handleAjaxImport:function(t){const s=t.find('input[type="file"]')[0],e=t.find('select[name="import_type"]').val(),r=t.find('input[name="update_existing"]').is(":checked");if(!s||!s.files.length)return void this.showNotice(mt_csv_import.i18n.no_file_selected,"error");if(!e)return void this.showNotice(mt_csv_import.i18n.no_type_selected,"error");const i=new FormData;i.append("action","mt_import_csv"),i.append("nonce",mt_csv_import.nonce),i.append("import_type",e),i.append("update_existing",r?"true":"false"),i.append("csv_file",s.files[0]),this.startImport(i)},startImport:function(e){this.isImporting=!0,this.showProgressModal(),this.updateProgress(5,mt_csv_import.i18n.uploading_file),t(".mt-import-export-container input, .mt-import-export-container select, .mt-import-export-container button").prop("disabled",!0),t.ajax({url:mt_csv_import.ajax_url,type:"POST",data:e,processData:!1,contentType:!1,xhr:function(){const t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",t=>{if(t.lengthComputable){const e=Math.round(t.loaded/t.total*50);s.updateProgress(e,mt_csv_import.i18n.uploading_file)}},!1),t},success:t=>{this.handleImportResponse(t)},error:(t,s,e)=>{this.handleImportError(t,s,e)},complete:()=>{this.isImporting=!1,this.hideProgressModal(),t(".mt-import-export-container input, .mt-import-export-container select, .mt-import-export-container button").prop("disabled",!1)}})},handleImportResponse:function(s){if(s.success){this.updateProgress(100,mt_csv_import.i18n.import_complete);let e=s.data.message||mt_csv_import.i18n.import_complete;if(s.data.data){const t=[];s.data.data.imported>0&&t.push(s.data.data.imported+" "+mt_csv_import.i18n.created),s.data.data.updated>0&&t.push(s.data.data.updated+" "+mt_csv_import.i18n.updated),s.data.data.skipped>0&&t.push(s.data.data.skipped+" "+mt_csv_import.i18n.skipped),s.data.data.errors>0&&t.push(s.data.data.errors+" "+mt_csv_import.i18n.errors),t.length&&(e+=" ("+t.join(", ")+")")}this.showNotice(e,"success"),s.data.data&&s.data.data.error_details&&s.data.data.error_details.length&&this.showErrorDetails(s.data.data.error_details),t("#csv_file").val("")}else this.updateProgress(0,mt_csv_import.i18n.import_failed),this.showNotice(s.data.message||mt_csv_import.i18n.import_failed,"error"),s.data.data&&s.data.data.error_details&&this.showErrorDetails(s.data.data.error_details)},handleImportError:function(t,s,e){let r=mt_csv_import.i18n.import_error;t.responseJSON&&t.responseJSON.data&&t.responseJSON.data.message?r=t.responseJSON.data.message:e&&(r+=": "+e),this.showNotice(r,"error"),this.updateProgress(0,mt_csv_import.i18n.import_failed)},validateFile:function(t){const s=t.target.files[0];if(!s)return;const e=s.name.split(".").pop().toLowerCase();if(!["csv","txt"].includes(e))return this.showNotice(mt_csv_import.i18n.invalid_file_type,"error"),void(t.target.value="");if(s.size>10485760)return this.showNotice(mt_csv_import.i18n.file_too_large,"error"),void(t.target.value="");const r=mt_csv_import.i18n.file_selected.replace("%s",s.name),i=" ("+this.formatFileSize(s.size)+")";this.showNotice(r+i,"info")},updateImportHelp:function(s){const e=t(s.target).val();if(!t(".import-type-help").length){const e=t("<p/>",{class:"import-type-help description",style:"margin-top: 10px;"});t(s.target).closest("td").append(e)}"candidates"===e?t(".import-type-help").html(mt_csv_import.i18n.candidates_help):"jury_members"===e?t(".import-type-help").html(mt_csv_import.i18n.jury_help):t(".import-type-help").html("")},setupProgressModal:function(){if(t("#mt-import-progress-modal").length)return;const s=t("<div/>",{id:"mt-import-progress-modal",class:"mt-modal",style:"display: none;",html:`\n                    <div class="mt-modal-content">\n                        <h2>${mt_csv_import.i18n.importing}</h2>\n                        <div class="mt-progress-wrapper">\n                            <div class="mt-progress-bar">\n                                <div class="mt-progress-bar-fill" style="width: 0%">\n                                    <span class="mt-progress-percentage">0%</span>\n                                </div>\n                            </div>\n                            <div class="mt-progress-stats">\n                                <span class="mt-progress-current">0</span> / <span class="mt-progress-total">0</span> records\n                            </div>\n                        </div>\n                        <p class="mt-progress-message">${mt_csv_import.i18n.please_wait}</p>\n                        <div class="mt-progress-details">\n                            <div class="mt-progress-item mt-progress-success" style="display: none;">\n                                <span class="icon">✓</span> <span class="label">${mt_csv_import.i18n.imported||"Imported"}:</span> <span class="count">0</span>\n                            </div>\n                            <div class="mt-progress-item mt-progress-updated" style="display: none;">\n                                <span class="icon">↻</span> <span class="label">${mt_csv_import.i18n.updated||"Updated"}:</span> <span class="count">0</span>\n                            </div>\n                            <div class="mt-progress-item mt-progress-skipped" style="display: none;">\n                                <span class="icon">⊘</span> <span class="label">${mt_csv_import.i18n.skipped||"Skipped"}:</span> <span class="count">0</span>\n                            </div>\n                            <div class="mt-progress-item mt-progress-errors" style="display: none;">\n                                <span class="icon">✗</span> <span class="label">${mt_csv_import.i18n.errors||"Errors"}:</span> <span class="count">0</span>\n                            </div>\n                        </div>\n                    </div>\n                `});t("body").append(s)},showProgressModal:function(){t("#mt-import-progress-modal").fadeIn(200)},hideProgressModal:function(){setTimeout(()=>{t("#mt-import-progress-modal").fadeOut(200)},1e3)},updateProgress:function(s,e,r){t(".mt-progress-bar-fill").css("width",s+"%"),t(".mt-progress-percentage").text(s+"%"),e&&t(".mt-progress-message").text(e),r&&(void 0!==r.total&&t(".mt-progress-total").text(r.total),void 0!==r.current&&t(".mt-progress-current").text(r.current),void 0!==r.success&&r.success>0&&t(".mt-progress-success").show().find(".count").text(r.success),void 0!==r.updated&&r.updated>0&&t(".mt-progress-updated").show().find(".count").text(r.updated),void 0!==r.skipped&&r.skipped>0&&t(".mt-progress-skipped").show().find(".count").text(r.skipped),void 0!==r.errors&&r.errors>0&&t(".mt-progress-errors").show().find(".count").text(r.errors))},showNotice:function(s,e){t(".mt-import-notice").remove();const r=t("<div/>",{class:"notice notice-"+e+" is-dismissible mt-import-notice",html:"<p>"+s+"</p>"}),i=t("<button/>",{type:"button",class:"notice-dismiss",html:'<span class="screen-reader-text">Dismiss this notice.</span>'});i.on("click",function(){r.fadeOut(200,function(){t(this).remove()})}),r.append(i);const o=t(".wrap h1").first();o.length?o.after(r):t(".wrap").prepend(r),"info"===e&&setTimeout(()=>{r.find(".notice-dismiss").click()},5e3)},showErrorDetails:function(s){if(!s||!s.length)return;let e='<div class="mt-error-details"><h4>'+mt_csv_import.i18n.error_details+"</h4><ul>";s.forEach(function(t){e+="<li>Row "+t.row+": "+t.error+"</li>"}),e+="</ul></div>";const r=t(e);t(".mt-import-notice").last().append(r)},formatFileSize:function(t){if(0===t)return"0 Bytes";const s=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB"][s]}};t(document).ready(function(){"undefined"!=typeof mt_csv_import&&s.init()}),window.MTCSVImport=s}(jQuery);
//# sourceMappingURL=csv-import.js.map