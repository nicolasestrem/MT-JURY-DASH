(r=>{let s={isImporting:!1,progressInterval:null,init:function(){this.bindEvents(),this.setupProgressModal()},bindEvents:function(){r("#mt-import-form").on("submit",this.handleFormSubmit.bind(this));var t=r('form[action*="admin-post.php"]').filter(function(){return 0<r(this).find('input[name="action"][value="mt_import_data"]').length});t.length&&this.enhanceStandardForm(t),r("#csv_file").on("change",this.validateFile.bind(this)),r("#import_type").on("change",this.updateImportHelp.bind(this))},enhanceStandardForm:function(s){var t,e=s.find('button[type="submit"]');e.length&&((t=r("<button/>",{type:"button",class:"button button-secondary mt-ajax-import-btn",html:'<span class="dashicons dashicons-upload"></span> '+mt_csv_import.i18n.ajax_import,style:"margin-left: 10px;"})).on("click",t=>{t.preventDefault(),this.handleAjaxImport(s)}),e.after(t))},handleFormSubmit:function(t){return t.preventDefault(),this.isImporting||(t=r(t.target),this.handleAjaxImport(t)),!1},handleAjaxImport:function(t){var s,e=t.find('input[type="file"]')[0],r=t.find('select[name="import_type"]').val(),t=t.find('input[name="update_existing"]').is(":checked");e&&e.files.length?r?((s=new FormData).append("action","mt_import_csv"),s.append("nonce",mt_csv_import.nonce),s.append("import_type",r),s.append("update_existing",t?"true":"false"),s.append("csv_file",e.files[0]),this.startImport(s)):this.showNotice(mt_csv_import.i18n.no_type_selected,"error"):this.showNotice(mt_csv_import.i18n.no_file_selected,"error")},startImport:function(t){this.isImporting=!0,this.showProgressModal(),this.updateProgress(5,mt_csv_import.i18n.uploading_file),r(".mt-import-export-container input, .mt-import-export-container select, .mt-import-export-container button").prop("disabled",!0),r.ajax({url:mt_csv_import.ajax_url,type:"POST",data:t,processData:!1,contentType:!1,xhr:function(){var t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",t=>{t.lengthComputable&&(t=Math.round(t.loaded/t.total*50),s.updateProgress(t,mt_csv_import.i18n.uploading_file))},!1),t},success:t=>{this.handleImportResponse(t)},error:(t,s,e)=>{this.handleImportError(t,s,e)},complete:()=>{this.isImporting=!1,this.hideProgressModal(),r(".mt-import-export-container input, .mt-import-export-container select, .mt-import-export-container button").prop("disabled",!1)}})},handleImportResponse:function(s){if(s.success){this.updateProgress(100,mt_csv_import.i18n.import_complete);let t=s.data.message||mt_csv_import.i18n.import_complete;var e;s.data.data&&(e=[],0<s.data.data.imported&&e.push(s.data.data.imported+" "+mt_csv_import.i18n.created),0<s.data.data.updated&&e.push(s.data.data.updated+" "+mt_csv_import.i18n.updated),0<s.data.data.skipped&&e.push(s.data.data.skipped+" "+mt_csv_import.i18n.skipped),0<s.data.data.errors&&e.push(s.data.data.errors+" "+mt_csv_import.i18n.errors),e.length)&&(t+=" ("+e.join(", ")+")"),this.showNotice(t,"success"),s.data.data&&s.data.data.error_details&&s.data.data.error_details.length&&this.showErrorDetails(s.data.data.error_details),r("#csv_file").val("")}else this.updateProgress(0,mt_csv_import.i18n.import_failed),this.showNotice(s.data.message||mt_csv_import.i18n.import_failed,"error"),s.data.data&&s.data.data.error_details&&this.showErrorDetails(s.data.data.error_details)},handleImportError:function(t,s,e){let r=mt_csv_import.i18n.import_error;t.responseJSON&&t.responseJSON.data&&t.responseJSON.data.message?r=t.responseJSON.data.message:e&&(r+=": "+e),this.showNotice(r,"error"),this.updateProgress(0,mt_csv_import.i18n.import_failed)},validateFile:function(t){var s,e=t.target.files[0];e&&(s=e.name.split(".").pop().toLowerCase(),["csv","txt"].includes(s)?10485760<e.size?(this.showNotice(mt_csv_import.i18n.file_too_large,"error"),t.target.value=""):(s=mt_csv_import.i18n.file_selected.replace("%s",e.name),e=" ("+this.formatFileSize(e.size)+")",this.showNotice(s+e,"info")):(this.showNotice(mt_csv_import.i18n.invalid_file_type,"error"),t.target.value=""))},updateImportHelp:function(t){var s,e=r(t.target).val();r(".import-type-help").length||(s=r("<p/>",{class:"import-type-help description",style:"margin-top: 10px;"}),r(t.target).closest("td").append(s)),"candidates"===e?r(".import-type-help").html(mt_csv_import.i18n.candidates_help):"jury_members"===e?r(".import-type-help").html(mt_csv_import.i18n.jury_help):r(".import-type-help").html("")},setupProgressModal:function(){var t;r("#mt-import-progress-modal").length||(t=r("<div/>",{id:"mt-import-progress-modal",class:"mt-modal",style:"display: none;",html:`
                    <div class="mt-modal-content">
                        <h2>${mt_csv_import.i18n.importing}</h2>
                        <div class="mt-progress-wrapper">
                            <div class="mt-progress-bar">
                                <div class="mt-progress-bar-fill" style="width: 0%">
                                    <span class="mt-progress-percentage">0%</span>
                                </div>
                            </div>
                            <div class="mt-progress-stats">
                                <span class="mt-progress-current">0</span> / <span class="mt-progress-total">0</span> records
                            </div>
                        </div>
                        <p class="mt-progress-message">${mt_csv_import.i18n.please_wait}</p>
                        <div class="mt-progress-details">
                            <div class="mt-progress-item mt-progress-success" style="display: none;">
                                <span class="icon">✓</span> <span class="label">${mt_csv_import.i18n.imported||"Imported"}:</span> <span class="count">0</span>
                            </div>
                            <div class="mt-progress-item mt-progress-updated" style="display: none;">
                                <span class="icon">↻</span> <span class="label">${mt_csv_import.i18n.updated||"Updated"}:</span> <span class="count">0</span>
                            </div>
                            <div class="mt-progress-item mt-progress-skipped" style="display: none;">
                                <span class="icon">⊘</span> <span class="label">${mt_csv_import.i18n.skipped||"Skipped"}:</span> <span class="count">0</span>
                            </div>
                            <div class="mt-progress-item mt-progress-errors" style="display: none;">
                                <span class="icon">✗</span> <span class="label">${mt_csv_import.i18n.errors||"Errors"}:</span> <span class="count">0</span>
                            </div>
                        </div>
                    </div>
                `}),r("body").append(t))},showProgressModal:function(){r("#mt-import-progress-modal").fadeIn(200)},hideProgressModal:function(){setTimeout(()=>{r("#mt-import-progress-modal").fadeOut(200)},1e3)},updateProgress:function(t,s,e){r(".mt-progress-bar-fill").css("width",t+"%"),r(".mt-progress-percentage").text(t+"%"),s&&r(".mt-progress-message").text(s),e&&(void 0!==e.total&&r(".mt-progress-total").text(e.total),void 0!==e.current&&r(".mt-progress-current").text(e.current),void 0!==e.success&&0<e.success&&r(".mt-progress-success").show().find(".count").text(e.success),void 0!==e.updated&&0<e.updated&&r(".mt-progress-updated").show().find(".count").text(e.updated),void 0!==e.skipped&&0<e.skipped&&r(".mt-progress-skipped").show().find(".count").text(e.skipped),void 0!==e.errors)&&0<e.errors&&r(".mt-progress-errors").show().find(".count").text(e.errors)},showNotice:function(t,s){r(".mt-import-notice").remove();let e=r("<div/>",{class:"notice notice-"+s+" is-dismissible mt-import-notice",html:"<p>"+t+"</p>"});t=r("<button/>",{type:"button",class:"notice-dismiss",html:'<span class="screen-reader-text">Dismiss this notice.</span>'}),t.on("click",function(){e.fadeOut(200,function(){r(this).remove()})}),e.append(t),t=r(".wrap h1").first();t.length?t.after(e):r(".wrap").prepend(e),"info"===s&&setTimeout(()=>{e.find(".notice-dismiss").click()},5e3)},showErrorDetails:function(t){if(t&&t.length){let s='<div class="mt-error-details"><h4>'+mt_csv_import.i18n.error_details+"</h4><ul>";t.forEach(function(t){s+="<li>Row "+t.row+": "+t.error+"</li>"}),s+="</ul></div>";t=r(s);r(".mt-import-notice").last().append(t)}},formatFileSize:function(t){var s;return 0===t?"0 Bytes":(s=Math.floor(Math.log(t)/Math.log(1024)),parseFloat((t/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB"][s])}};r(document).ready(function(){"undefined"!=typeof mt_csv_import&&s.init()}),window.MTCSVImport=s})(jQuery);