(r=>{let t={ajaxUrl:mt_debug.ajax_url||ajaxurl,nonce:mt_debug.nonce,activeTab:null,init:function(){this.bindEvents(),this.initActiveTab(),this.initTooltips(),this.startAutoRefresh()},bindEvents:function(){r(document).on("click",".nav-tab",this.handleTabClick.bind(this)),r(document).on("submit",".diagnostic-form",this.handleDiagnosticSubmit.bind(this)),r(document).on("click",".mt-run-diagnostic",this.runDiagnostic.bind(this)),r(document).on("click",".mt-export-diagnostics",this.exportDiagnostics.bind(this)),r(document).on("click",".mt-execute-script",this.executeScript.bind(this)),r(document).on("click",".mt-run-maintenance",this.runMaintenance.bind(this)),r(document).on("click",".mt-copy-sysinfo",this.copySystemInfo.bind(this)),r(document).on("click",".mt-export-sysinfo",this.exportSystemInfo.bind(this)),r(document).on("click",".mt-refresh-widget",this.refreshWidget.bind(this))},initActiveTab:function(){var t=new URLSearchParams(window.location.search);this.activeTab=t.get("tab")||"diagnostics"},initTooltips:function(){r.fn.tooltip&&r(".mt-tooltip").tooltip({position:{my:"center bottom-10",at:"center top"}})},startAutoRefresh:function(){setInterval(()=>{"diagnostics"===this.activeTab&&this.refreshWidget({target:r('[data-widget="system_status"]')[0]})},3e4)},handleTabClick:function(t){t=r(t.currentTarget).attr("href").match(/tab=([^&]+)/);t&&(this.activeTab=t[1])},handleDiagnosticSubmit:function(t){t.preventDefault(),this.runDiagnostic(t)},runDiagnostic:function(t){t.preventDefault();t=r(t.currentTarget);let e=t.is("form")?t.find('button[name="run_diagnostic"]'):t;t=e.closest("form").find("#diagnostic_type").val()||"full";e.prop("disabled",!0).addClass("updating-message");let i=e.text();e.text(mt_debug.i18n.running||"Running..."),r.ajax({url:this.ajaxUrl,type:"POST",data:{action:"mt_run_diagnostic",nonce:this.nonce,diagnostic_type:t},success:t=>{t.success?(this.displayDiagnosticResults(t.data),this.showNotification(mt_debug.i18n.diagnostic_complete||"Diagnostic complete","success")):this.showNotification(t.data||mt_debug.i18n.diagnostic_failed||"Diagnostic failed","error")},error:()=>{this.showNotification(mt_debug.i18n.network_error||"Network error occurred","error")},complete:()=>{e.prop("disabled",!1).removeClass("updating-message").text(i)}})},displayDiagnosticResults:function(t){let e=r(".mt-diagnostics-tab .diagnostic-results"),i=(e.length||(e=r('<div class="diagnostic-results mt-debug-section"></div>'),r(".mt-diagnostics-tab").append(e)),"<h3>"+(mt_debug.i18n.diagnostic_results||"Diagnostic Results")+"</h3>");if(i+='<div class="mt-diagnostic-timestamp">Run at: '+(t.timestamp||(new Date).toLocaleString())+"</div>",t.diagnostics)for(var[s,o]of Object.entries(t.diagnostics)){if(i=(i+='<div class="mt-diagnostic-section">')+("<h4>"+this.formatSectionName(s)+"</h4>")+'<div class="mt-diagnostic-items">',"object"==typeof o&&null!==o)for(var[a,n]of Object.entries(o)){var c=this.getDiagnosticStatus(a,n);i=(i=(i+='<div class="mt-diagnostic-item '+c.class+'">')+('<span class="mt-diagnostic-label">'+this.formatLabel(a)+":</span>"))+('<span class="mt-diagnostic-value">'+this.formatValue(n)+"</span>"),c.icon&&(i+='<span class="dashicons '+c.icon+'"></span>'),i+="</div>"}else i+='<div class="mt-diagnostic-item">'+o+"</div>";i+="</div></div>"}e.html(i),r("html, body").animate({scrollTop:e.offset().top-100},500)},formatSectionName:function(t){return t.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase())},formatLabel:function(t){return t.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase())},formatValue:function(t){return"boolean"==typeof t?t?"✓ Yes":"✗ No":"object"==typeof t&&null!==t?JSON.stringify(t,null,2):String(t)},getDiagnosticStatus:function(t,e){return t.includes("error")||t.includes("failed")?{class:"mt-diagnostic-error",icon:"dashicons-warning"}:t.includes("warning")||t.includes("deprecated")?{class:"mt-diagnostic-warning",icon:"dashicons-info"}:!0===e||t.includes("success")||t.includes("valid")?{class:"mt-diagnostic-success",icon:"dashicons-yes-alt"}:!1===e||t.includes("invalid")?{class:"mt-diagnostic-error",icon:"dashicons-dismiss"}:{class:"",icon:""}},exportDiagnostics:function(t){t.preventDefault();let e=r(t.currentTarget);e.prop("disabled",!0),r.ajax({url:this.ajaxUrl,type:"POST",data:{action:"mt_export_diagnostics",nonce:this.nonce},success:t=>{t.success?(this.downloadJSON(t.data.data,t.data.filename),this.showNotification(mt_debug.i18n.export_complete||"Export complete","success")):this.showNotification(t.data||mt_debug.i18n.export_failed||"Export failed","error")},error:()=>{this.showNotification(mt_debug.i18n.network_error||"Network error occurred","error")},complete:()=>{e.prop("disabled",!1)}})},executeScript:function(e){e.preventDefault();let t=r(e.currentTarget);var i=t.data("script"),s=t.data("dangerous");s&&!confirm(mt_debug.i18n.confirm_dangerous||"This is a dangerous operation. Are you sure?")||(t.prop("disabled",!0).addClass("updating-message"),r.ajax({url:this.ajaxUrl,type:"POST",data:{action:"mt_execute_debug_script",nonce:this.nonce,script:i,params:{confirm:!!s}},success:t=>{t.success?(this.showScriptOutput(t.data),this.showNotification(mt_debug.i18n.script_complete||"Script executed","success")):t.data&&t.data.requires_confirmation?confirm(t.data.message)&&this.executeScript(e):this.showNotification(t.data||mt_debug.i18n.script_failed||"Script failed","error")},error:()=>{this.showNotification(mt_debug.i18n.network_error||"Network error occurred","error")},complete:()=>{t.prop("disabled",!1).removeClass("updating-message")}}))},showScriptOutput:function(t){let e=r('<div class="mt-modal">').html(`
                <div class="mt-modal-content">
                    <h3>${mt_debug.i18n.script_output||"Script Output"}</h3>
                    <div class="mt-script-output">${t.output||"<p>No output generated</p>"}</div>
                    ${t.errors&&t.errors.length?`<div class="notice notice-error">
                            <p>${mt_debug.i18n.errors_occurred||"Errors occurred"}:</p>
                            <ul>${t.errors.map(t=>`<li>${this.escapeHtml(t.message)}</li>`).join("")}</ul>
                        </div>`:""}
                    <button class="button mt-close-modal">${mt_debug.i18n.close||"Close"}</button>
                </div>
            `);r("body").append(e),e.on("click",".mt-close-modal, .mt-modal",function(t){t.target!==this&&!r(t.target).hasClass("mt-close-modal")||e.remove()})},runMaintenance:function(t){t.preventDefault();let e=r(t.currentTarget),i=e.data("category"),s=e.data("operation");t=e.data("dangerous");t&&!confirm(mt_debug.i18n.confirm_dangerous||"This is a dangerous operation. Are you sure?")||(e.prop("disabled",!0).addClass("updating-message"),r.ajax({url:this.ajaxUrl,type:"POST",data:{action:"mt_run_maintenance",nonce:this.nonce,category:i,operation:s,params:{confirm:!!t}},success:t=>{t.success?(this.showNotification(t.data.message||mt_debug.i18n.operation_complete||"Operation complete","success"),t.data.data):t.data&&t.data.requires_password?this.promptPassword(i,s):this.showNotification(t.data||mt_debug.i18n.operation_failed||"Operation failed","error")},error:()=>{this.showNotification(mt_debug.i18n.network_error||"Network error occurred","error")},complete:()=>{e.prop("disabled",!1).removeClass("updating-message")}}))},promptPassword:function(t,e){var i=prompt(mt_debug.i18n.enter_password||"Enter your admin password:");i&&r.ajax({url:this.ajaxUrl,type:"POST",data:{action:"mt_run_maintenance",nonce:this.nonce,category:t,operation:e,params:{confirm:!0,password:i}},success:t=>{t.success?this.showNotification(t.data.message||mt_debug.i18n.operation_complete||"Operation complete","success"):this.showNotification(t.data||mt_debug.i18n.operation_failed||"Operation failed","error")}})},refreshWidget:function(t){t.preventDefault();let e=r(t.target).closest(".mt-widget");t=e.data("widget");e.addClass("updating"),r.ajax({url:this.ajaxUrl,type:"POST",data:{action:"mt_refresh_debug_widget",nonce:this.nonce,widget_id:t},success:t=>{t.success&&e.find(".mt-widget-content").html(t.data.html)},complete:()=>{e.removeClass("updating")}})},downloadJSON:function(t,e){var t=new Blob([t],{type:"application/json"}),t=URL.createObjectURL(t),i=document.createElement("a");i.href=t,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(t)},showNotification:function(t,e="info"){let i=r(`
                <div class="notice notice-${e} is-dismissible mt-notification">
                    <p>${t}</p>
                    <button type="button" class="notice-dismiss">
                        <span class="screen-reader-text">${mt_debug.i18n.dismiss||"Dismiss"}</span>
                    </button>
                </div>
            `);r(".wrap h1").first().after(i),setTimeout(()=>{i.fadeOut(()=>i.remove())},5e3),i.on("click",".notice-dismiss",function(){i.fadeOut(()=>i.remove())})},escapeHtml:function(t){let e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,t=>e[t])},copySystemInfo:function(t){t.preventDefault();r(t.currentTarget);t=r("#system-info-export");t.length&&(t[0].select(),document.execCommand("copy"),this.showNotification(mt_debug.i18n.copied||"Copied to clipboard","success"))},exportSystemInfo:function(t){t.preventDefault(),r.ajax({url:this.ajaxUrl,type:"POST",data:{action:"mt_get_system_info",nonce:this.nonce},success:t=>{var e;t.success&&(e="mt-sysinfo-"+(new Date).toISOString().slice(0,10)+".json",this.downloadJSON(JSON.stringify(t.data,null,2),e))}})}};r(document).ready(function(){r(".mt-debug-center").length&&t.init()})})(jQuery);